<!doctype html>
<html>
<head>
  <meta charset=utf-8>
  <title>GBA.js</title>
  <link rel=stylesheet href="../style.css">
</head>
<body>

  <div id=main class=story>

    <h1>The making of GBA.js</h1>

    <h2>Episode 2: The code bootstrap</h2>
    <article>
      After reading all this information, and well thought about it, I set up my project.
      <br>
      <br>
      - In <b>index.html</b>, I display a canvas element representing the GBA screen.
      <br>
      Note that <abbr title="Internet Explorer 8">IE8</abbr> and lower don't support HTML5 canvas natively, so I will only support <abbr title="Internet Explorer 9">IE9</abbr> and higher.
      <br>
      There's also a progressbar, we'll use it in the next chapter.
      <br>
      I include GBA.js and feed the "gba" function with <b>test.gba</b> (a <a href="http://gbaemu.dcemu.co.uk/gba_roms.shtml">GBAnews</a> ROM), the canvas and the progressbar.
      <br>
      <br>
      <pre><code class="language-markup">
&lt;!doctype html>
&lt;html>
&lt;head>
  &lt;meta charset=utf-8>
  &lt;title>GBA.js&lt;/title>
&lt;/head>
&lt;body>
  &lt;progress id=progress>&lt;/progress>
  &lt;canvas id=screen width=240 height=160>&lt;/canvas>
  &lt;script src=GBA.js>&lt;/script>
  &lt;script>
    gba('test.gba', document.getElementById('screen'), document.getElementById('progress'));
  &lt;/script>
&lt;/body>
&lt;/html>
        </code></pre>
      <br>
      - In <b>GBA.js</b>, I'll put the whole emulator in a single function.
      <br>
      I initialize all the vars that will be used by the emulator (temp vars, <a href="http://nocash.emubase.de/gbatek.htm#cpuregisterset">CPU registers</a>, <a href="http://nocash.emubase.de/gbatek.htm#gbamemorymap">memory</a>, bit masks...)
      <br>
      I also prepare the main emulator's function: play(), and the unit tests: test().
      <br>
      <br>
      <pre><code class="language-javascript">
/**
* GBA.js - GameBoy Advance emulator in JavaScript
* @author Maxime Euzi√®re
* @param file: the file name/path of the GBA game ROM to play.
* @param canvas: the HTML canvas element to use as a GBA screen (240 * 160 px).
* @param progressbar (optional): the HTML progress element showing the ROM loading status.
**/
function gba(file, canvas, progressbar){

  /******************
    Initializations 
  ******************/

  var

// JavaScript vars
i, x, y,              // Loop counters
t, u, v, w, z,        // Temp vars

// AJAX
xhr = new XMLHttpRequest,

// CPU registers
r = [],               // CPU registers 0 - 14
cpsr = 0x00000010,    // Current program status register (default setting: "user mode", "ARM state")
pca = 0x8000000,      // Program counter address
pc,                   // Program counter (current instruction)

// Banked registers
r_irq = [],           // IRQ banked registers (r13, r14)
cpsr_irq,             // IRQ banked cpsr
r_fiq = [],           // FIQ banked registers (r8-14)
cpsr_fiq,             // FIQ banked cpsr
r_svc = [],           // SVC banked registers (r13, r14)
cpsr_svc,             // SVC banked cpsr
r_abt = [],           // ABT banked registers (r13, r14)
cpsr_abt,             // ABT banked cpsr
r_und = [],           // UND banked registers (r13, r14)
cpsr_und,             // UND banked cpsr

// Memory
m = {                 // The whole memory
  0x2: [],            // EWRAM (addresses 0x02XXXXXX)
  0x3: [],            // IWRAM (addresses 0x03XXXXXX)
  0x4: [],            // I/0(addresses 0x04XXXXXX)
  0x5: [],            // Palette RAM (addresses 0x05XXXXXX)
  0x6: [],            // VRAM (addresses 0x06XXXXXX)
  0x7: [],            // OAM (addresses 0x07XXXXXX)
  0x8: [],            // Game Pak ROM (addresses 0x08XXXXXX and 0x09XXXXXX)
  0xE: []             // Game Pak RAM (addresses 0x0EXXXXXX)
},

// Bit masks to access regions of I/O registers
bit0 = 0x1,
bit1 = 0x2,
bit2 = 0x4,
bit3 = 0x8,
bit4 = 0x10,
bit5 = 0x20,
bit6 = 0x40,
bit7 = 0x80,
bit8 = 0x100,
bit9 = 0x200,
bit10 = 0x400,
bit11 = 0x800,
bit12 = 0x1000,
bit13 = 0x2000,
bit14 = 0x4000,
bit15 = 0x8000,
bit27 = 0x8000000,
bits0_1 = 0x3,
bits0_2 = 0x7,
bits0_3 = 0xF,
bits0_4 = 0x1F,
bits0_5 = 0x3F,
bits0_7 = 0xFF,
bits0_9 = 0x3FF,
bits0_A = 0x7FF,
bits0_D = 0x3FFF,
bits0_F = 0xFFFF,
bits1_9 = 0x3FE,
bits2_3 = 0xC,
bits4_5 = 0x30,
bits4_6 = 0x70,
bits4_7 = 0xF0,
bits5_6 = 0x60,
bits6_7 = 0xC0,
bits7_8 = 0x180,
bits8_9 = 0x300,
bits8_A = 0x700,
bits8_B = 0xF00,
bits8_C = 0x1F00,
bits8_E = 0x7F00,
bits8_F = 0xFF00,
bitsC_D = 0x3000,
bitsC_F = 0xF000,
bitsD_F = 0xE000,
bitsE_F = 0xC000,
bits0_26 = 0x7FFFFFF,
bits0_27 = 0xFFFFFFF,
bits0_31 = 0xFFFFFFFF,
bits8_26 = 0x7FFFF00;

// CPU registers default values */
r[13] = 0x3007F00;                   // default r13 value when processor mode is "user"


  /************
    Functions
  ************/

  /* Play the game ROM */
  function play(){
    test(); return;     // Comment this line to run the game normally
  }
  
  /* Test the emulator */
  function test(){
  
  }
}
      </code></pre>
    </article>

    <br>
    <br>

    <nav>
      <a href="1.html" class=left>Previous page</a>
      <a href="3.html" class=right>Next page</a>
    </nav>

  </div>

  <!-- links -->
  <a href="http://twitter.com/MaximeEuziere">@MaximeEuziere</a>
  -
  <a href="..">Online version</a>
  -
  <a href="http://github.com/xem/gba.js">GitHub</a>

  <script>
    /**
    * Prism: Lightweight, robust, elegant syntax highlighting
    * MIT license http://www.opensource.org/licenses/mit-license.php/
    * @author Lea Verou http://lea.verou.me
    */(function(){var e=/\blang(?:uage)?-(?!\*)(\w+)\b/i,t=self.Prism={languages:{insertBefore:function(e,n,r,i){i=i||t.languages;var s=i[e],o={};for(var u in s)if(s.hasOwnProperty(u)){if(u==n)for(var a in r)r.hasOwnProperty(a)&&(o[a]=r[a]);o[u]=s[u]}return i[e]=o},DFS:function(e,n){for(var r in e){n.call(e,r,e[r]);Object.prototype.toString.call(e)==="[object Object]"&&t.languages.DFS(e[r],n)}}},highlightAll:function(e,n){var r=document.querySelectorAll('code[class*="language-"], [class*="language-"] code, code[class*="lang-"], [class*="lang-"] code');for(var i=0,s;s=r[i++];)t.highlightElement(s,e===!0,n)},highlightElement:function(r,i,s){var o,u,a=r;while(a&&!e.test(a.className))a=a.parentNode;if(a){o=(a.className.match(e)||[,""])[1];u=t.languages[o]}if(!u)return;r.className=r.className.replace(e,"").replace(/\s+/g," ")+" language-"+o;a=r.parentNode;/pre/i.test(a.nodeName)&&(a.className=a.className.replace(e,"").replace(/\s+/g," ")+" language-"+o);var f=r.textContent.trim();if(!f)return;f=f.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\u00a0/g," ");var l={element:r,language:o,grammar:u,code:f};t.hooks.run("before-highlight",l);if(i&&self.Worker){var c=new Worker(t.filename);c.onmessage=function(e){l.highlightedCode=n.stringify(JSON.parse(e.data));l.element.innerHTML=l.highlightedCode;s&&s.call(l.element);t.hooks.run("after-highlight",l)};c.postMessage(JSON.stringify({language:l.language,code:l.code}))}else{l.highlightedCode=t.highlight(l.code,l.grammar);l.element.innerHTML=l.highlightedCode;s&&s.call(r);t.hooks.run("after-highlight",l)}},highlight:function(e,r){return n.stringify(t.tokenize(e,r))},tokenize:function(e,n){var r=t.Token,i=[e],s=n.rest;if(s){for(var o in s)n[o]=s[o];delete n.rest}e:for(var o in n){if(!n.hasOwnProperty(o)||!n[o])continue;var u=n[o],a=u.inside,f=!!u.lookbehind||0;u=u.pattern||u;for(var l=0;l<i.length;l++){var c=i[l];if(i.length>e.length)break e;if(c instanceof r)continue;u.lastIndex=0;var h=u.exec(c);if(h){f&&(f=h[1].length);var p=h.index-1+f,h=h[0].slice(f),d=h.length,v=p+d,m=c.slice(0,p+1),g=c.slice(v+1),y=[l,1];m&&y.push(m);var b=new r(o,a?t.tokenize(h,a):h);y.push(b);g&&y.push(g);Array.prototype.splice.apply(i,y)}}}return i},hooks:{all:{},add:function(e,n){var r=t.hooks.all;r[e]=r[e]||[];r[e].push(n)},run:function(e,n){var r=t.hooks.all[e];if(!r||!r.length)return;for(var i=0,s;s=r[i++];)s(n)}}},n=t.Token=function(e,t){this.type=e;this.content=t};n.stringify=function(e){if(typeof e=="string")return e;if(Object.prototype.toString.call(e)=="[object Array]"){for(var r=0;r<e.length;r++)e[r]=n.stringify(e[r]);return e.join("")}var i={type:e.type,content:n.stringify(e.content),tag:"span",classes:["token",e.type],attributes:{}};i.type=="comment"&&(i.attributes.spellcheck="true");t.hooks.run("wrap",i);var s="";for(var o in i.attributes)s+=o+'="'+(i.attributes[o]||"")+'"';return"<"+i.tag+' class="'+i.classes.join(" ")+'" '+s+">"+i.content+"</"+i.tag+">"};if(!self.document){self.addEventListener("message",function(e){var n=JSON.parse(e.data),r=n.language,i=n.code;self.postMessage(JSON.stringify(t.tokenize(i,t.languages[r])));self.close()},!1);return}var r=document.getElementsByTagName("script");r=r[r.length-1];if(r){t.filename=r.src;document.addEventListener&&!r.hasAttribute("data-manual")&&document.addEventListener("DOMContentLoaded",t.highlightAll)}})();
    Prism.languages.markup={comment:/&lt;!--[\w\W]*?--(&gt;|&gt;)/g,prolog:/&lt;\?.+?\?&gt;/,doctype:/&lt;!DOCTYPE.+?&gt;/,cdata:/&lt;!\[CDATA\[[\w\W]+?]]&gt;/i,tag:{pattern:/&lt;\/?[\w:-]+\s*[\w\W]*?&gt;/gi,inside:{tag:{pattern:/^&lt;\/?[\w:-]+/i,inside:{punctuation:/^&lt;\/?/,namespace:/^[\w-]+?:/}},"attr-value":{pattern:/=(('|")[\w\W]*?(\2)|[^\s>]+)/gi,inside:{punctuation:/=/g}},punctuation:/\/?&gt;/g,"attr-name":{pattern:/[\w:-]+/g,inside:{namespace:/^[\w-]+?:/}}}},entity:/&amp;#?[\da-z]{1,8};/gi};Prism.hooks.add("wrap",function(e){e.type==="entity"&&(e.attributes.title=e.content.replace(/&amp;/,"&"))});
    Prism.languages.css={comment:/\/\*[\w\W]*?\*\//g,atrule:/@[\w-]+?(\s+.+)?(?=\s*{|\s*;)/gi,url:/url\((["']?).*?\1\)/gi,selector:/[^\{\}\s][^\{\}]*(?=\s*\{)/g,property:/(\b|\B)[a-z-]+(?=\s*:)/ig,string:/("|')(\\?.)*?\1/g,important:/\B!important\b/gi,ignore:/&(lt|gt|amp);/gi,punctuation:/[\{\};:]/g};Prism.languages.markup&&Prism.languages.insertBefore("markup","tag",{style:{pattern:/(&lt;|<)style[\w\W]*?(>|&gt;)[\w\W]*?(&lt;|<)\/style(>|&gt;)/ig,inside:{tag:{pattern:/(&lt;|<)style[\w\W]*?(>|&gt;)|(&lt;|<)\/style(>|&gt;)/ig,inside:Prism.languages.markup.tag.inside},rest:Prism.languages.css}}});
    Prism.languages.javascript={comment:{pattern:/(^|[^\\])(\/\*[\w\W]*?\*\/|\/\/.*?(\r?\n|$))/g,lookbehind:!0},string:/("|')(\\?.)*?\1/g,regex:{pattern:/(^|[^/])\/(?!\/)(\[.+?]|\\.|[^/\r\n])+\/[gim]{0,3}(?=\s*($|[\r\n,.;})]))/g,lookbehind:!0},keyword:/\b(var|let|if|else|while|do|for|return|in|instanceof|function|new|with|typeof|try|catch|finally|null|break|continue)\b/g,"boolean":/\b(true|false)\b/g,number:/\b-?(0x)?\d*\.?\d+\b/g,operator:/[-+]{1,2}|!|=?&lt;|=?&gt;|={1,2}|(&amp;){1,2}|\|?\||\?|\*|\//g,ignore:/&(lt|gt|amp);/gi,punctuation:/[{}[\];(),.:]/g};Prism.languages.markup&&Prism.languages.insertBefore("markup","tag",{script:{pattern:/(&lt;|<)script[\w\W]*?(>|&gt;)[\w\W]*?(&lt;|<)\/script(>|&gt;)/ig,inside:{tag:{pattern:/(&lt;|<)script[\w\W]*?(>|&gt;)|(&lt;|<)\/script(>|&gt;)/ig,inside:Prism.languages.markup.tag.inside},rest:Prism.languages.javascript}}});
    Prism.languages.java={comment:{pattern:/(^|[^\\])(\/\*[\w\W]*?\*\/|\/\/.*?(\r?\n|$))/g,lookbehind:true},string:/("|')(\\?.)*?\1/g,keyword:/\b(abstract|continue|for|new|switch|assert|default|goto|package|synchronized|boolean|do|if|private|this|break|double|implements|protected|throw|byte|else|import|public|throws|case|enum|instanceof|return|transient|catch|extends|int|short|try|char|final|interface|static|void|class|finally|long|strictfp|volatile|const|float|native|super|while)\b/g,"boolean":/\b(true|false)\b/g,number:/\b-?(0x)?\d*\.?\d+\b/g,operator:/[-+]{1,2}|!|=?<|=?>|={1,2}|(&){1,2}|\|?\||\?|\*|\/|%|\^|(<){2}|($gt;){2,3}|:|~/g,ignore:/&(lt|gt|amp);/gi,punctuation:/[{}[\];(),.:]/g}
</script>

</body>
</html>